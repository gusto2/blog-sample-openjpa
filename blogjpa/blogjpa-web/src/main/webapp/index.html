<!DOCTYPE html>
<html>
    <head>
        <title>BlogJPA web client</title>
        <meta charset="utf-8">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi">
        <!--<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.4.2/pure-min.css">-->   
        <link rel="stylesheet" href="./css/test.css" />
        <link rel="stylesheet" href="./css/bootstrap.css" />
        <script src="http://yui.yahooapis.com/3.17.2/build/yui/yui-min.js"></script>
        <!--<script src="./js/person.js"></script>-->
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>
    <body class="yui3-skin-sam">
        <div id="message"></div>
        <div id="app">
            <div id="personTable"></div>
            <div><button id="updateBtn" class="btn">Refresh</button></div>
        </div>
        <!--<script src="./js/person.js"></script>-->
        <script type="text/javascript">
            YUI().use('app', 'node', 'event', 'escape',
                    'model', 'model-list', 'model-sync-rest', 'io', 'json-parse',
                    'datatable',
                    function(Y) {

                        function message(msg) {
                            var node = Y.one('#message');
                            if (!node && msg && msg != '')
                                alert(msg);
                            else
                                node.setHTML(Y.Escape.html(msg));
                        }

// model
                        Y.Person = Y.Base.create('person', Y.Model, [Y.ModelSync.REST], {
                            root: '/services/blog/person',
                            url: '/services/blog/person/{id}',
                            // overriding a default savw fn , just for demo purposes
                            parse: function(response) {
                                var resp = Y.JSON.parse(response);
                                var person = resp.person;
                                if (!person) {
                                    fire('error', {type: 'parse', error: 'Unexpected message format'})
                                }
                                else
                                    return person;
                            },
                            save: function(callback) {
                                Y.io(this.url, {
                                    method: 'POST',
                                    data: {"person": this.toJSON()},
                                    context: this,
                                    on: {
                                        success: function(tid, xhr) {
                                            // doesn't want to load the +id attr
//                                    this.parse(xhr.responseText);
//                                    this.parse(resp);
                                            this.fire("change");
                                            if (callback)
                                                callback();
                                        },
                                        failure: function(tid, xhr) {
                                            this.fire("error", {type: 'save', error: 'Cannot save the person', data: xhr});
                                            if (callback)
                                            {
                                                var m = (xhr.responseText) ? xhr.responseText : xhr.statusText;
                                                callback(m);
                                            }
                                        }
                                    }
                                });
                            },
                            ATTR: {
                                id: {},
                                name: {value: null},
                                address: {value: null},
                            }
                        });

                        Y.PersonList = Y.Base.create('persons', Y.ModelList, [Y.ModelSync.REST], {
//                     By convention `Y.User`'s `root` will be used for `Y.Users` as well.
                            root: '/services/blog/person',
                            url: '/services/blog/person',
                            model: Y.Person,
                            parse: function(response) {
                                var obj = Y.JSON.parse(response);
                                if (!obj.person)
                                {
                                    this.fire('error', {type: 'parse', error: 'Unexpected message format'})
                                    return;
                                }
                                return obj.person;
                            }
                        });


// view
                        Y.PersonListView = Y.Base.create("personListView", Y.View, [], {
                            model: new Y.PersonList(),
                            dataTable: new Y.DataTable({
                                data: this.model,
                                columns: [
                                    {
                                        key: 'name',
                                        label: 'name',
                                        allowHTML: true,
                                        formatter: function(o) {
                                            return '<a href="/detail/' + o.data.id + '">' + o.data.name + '</a>';
                                        }
                                    },
                                    'address'],
                                recordType: Y.Person
                            }),
                            initializer: function() {
                                var model = this.model;
                                if (!model) {
                                    alert('personlist model is not defined');
                                    return;
                                }
                                ;
                                // Re-render this view when the model changes, and destroy this view when
                                // the model is destroyed.
//                                model.after('change', this.updateTable, this);
                                model.after('destroy', this.destroy, this);
                            },
                            render: function() {
                                var dataTable = this.dataTable;
                                var model = this.model;
                                dataTable.data = model;
                                model.load(function(e) {
                                    if (!e) {
                                        dataTable.render('#personTable');
                                        message('Data rendered ' + Y.JSON.stringify(dataTable.data.toJSON()));
                                        model.fire('change');
                                    }
                                    else {
                                        message(e);
                                    }
                                });
                                
                                Y.one('#updateBtn').on('click', function(evt) {
                                        dataTable.data.load(function(e) {
                                            if (!e) {
                                                message('Data rendered ' + Y.JSON.stringify(dataTable.data.toJSON()));
                                            }
                                            else {
                                                message(e);
                                            }
                                        });                                    
                                });
                            },
                            events: {
//                                'button': {click: function(evt) {
//                                        dataTable.data.load(function(e) {
//                                            if (!e) {
//                                                message('Data rendered ' + Y.JSON.stringify(dataTable.data.toJSON()));
//                                            }
//                                            else {
//                                                message(e);
//                                            }
//                                        });
//                                        alert('updating table..');
//                                    }}
                            }
                        });

//                        // code
//                        var personList = new Y.PersonList();
//                        personList.load(function(e) {
//                            if (!e) {
//                                message(Y.JSON.stringify(personList.toJSON()));
//                            }
//                            else {
//                                message(e);
//                            }
//                        });


                        var app = new Y.App({
                            views: {
                                home: {type: 'PersonListView'},
                            },
                            viewContainer: '#app',
                            transitions: true,
                            serverSupport: false
                        });
                        app.showView('home');
                    }
            );
            // define person
        </script>
    </body>
</html>